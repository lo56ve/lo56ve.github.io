---
layout: post
title: callback,async
categories: [blog ]
tags: [ ]
description: js理解回调函数和异步
---

### 前言

回调函数和异步，其实我很早前就听说过，之前学习jquery时候，经常会用到一些方法，里面就带有回调函数，比如:
	
	btn.on('click',function(){
		console.log('我是回调函数');
	})

然后在慕课网学习的时候，老师也教过：在一个函数执行时，可以加上一个回调函数，让函数执行完成时候调用回调函数，形式差不多是这样：

	function f1(f2){
		//执行f1函数的代码
		console.log('我是f1的执行函数');
		if(f2){
			f2();	
		}
		// 上面回调函数的条件判断也可以写成 f2 && f2();
	}

这样子实现函数的回调。然后对于异步，我是真的一脸懵逼，网上举的例子我都能懂，但是一直觉得javascript是单线程，如果要执行主线程，那还有其他线程去执行异步中的函数吗？直到我看到了阮老师的文章~

### 传送门

[Javascript异步编程的4中方法 【阮一峰】](http://www.ruanyifeng.com/blog/2012/12/asynchronous%EF%BC%BFjavascript.html)

### javascript线程

javasript引擎是`单线程`运行的，浏览器无论在什么时候都有且只有一个线程在运行javascript程序

浏览器的内核是多线程的，他们在内核控制下相互配合以保持同步，一个浏览器至少实现三个常驻线程：**javascript引擎线程，GUI渲染线程，浏览器事件触发线程**。

`javascript`引擎是基于事件驱动单线程执行的，javascript引擎一直等待着任务队列中任务的到来，然后加以处理，浏览器无论什么时候只有**一个javascript线程在运行javascript程序**。

`GUI渲染线程`负责渲染浏览器界面，当界面需要重绘或由于某种操作引发回流时，该线程就会执行。但是需要注意，`GUI渲染线程与javascript引擎是互斥的`，当javascript引擎执行时GUI线程会被挂起，GUI更新会被保存在一个队列中等待javascript引擎空闲时立即被执行。

`事件触发线程`，当一个事件被触发时该线程会把事件添加到待**处理队列的队尾**，等待javascript引擎的处理。这些事件可来自javascript引擎**当前执行代码块如setTimeout、也可以来自浏览器内核的其他线程如鼠标点击、ajax异步请求等**，但由于javascript的单线程关系所有这些事件都得**排队等待javascript引擎处理**（当线程中没有执行任何同步代码的前提下才会执行异步代码）。

### 同步任务和异步任务

因此，单线程如果前一个任务耗时很长，后一个任务就不得不一直等着，没有结果就不会向下执行，这就是同步模式。

#### 所有的任务可以分为两种：`同步任务`和`异步任务`

- 同步任务：在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务。

- 异步任务：不进入主线程、而进入“任务队列”的任务，只有“任务队列”通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。像上述的事件触发线程中事件触发就添加到待处理的队列就是异步任务。

**执行栈** javascript引擎

**任务队列** 事件触发线程后添加到的队列

`异步执行的运行机制`:

- 所有同步任务都在主线程上执行，形成一个**执行栈**
- 主线程之外，还存在一个**任务队列**。只要异步任务有了运行结果，就在**任务队列**之中放置一个事件
- 一旦**执行栈**中的所有同步任务执行完毕，系统就会读取**任务队列**，看看里面有哪些事件。哪些对应的异步任务，于是结束等待状态，进入执行栈，开始执行
- 主线程不断重复上面的第三步

### 例子

<figure>
        <img src="https://lo56ve.github.io/img/example1.jpg">
</figure>

### 异步的4中方式

#### 一、和回调函数结合

其实回调函数和异步没什么必然联系，只是很多时候结合使用

<figure>
        <img src="https://lo56ve.github.io/img/async1.png">
</figure>

像这里因为f1函数是比较耗时的任务，为了不阻塞主程序的执行，就把f1的代码加上settimeout方法（这方法放置在事件触发线程中，不在主线程，等待主线程执行完成之后，事件触发线程放置到主线程上执行，见js线程和settimeout），此时继续执行f1下面的其他 js代码，如果f1函数执行完毕就调用callback函数即回调函数，也就是f2函数（此函数必须在f1之后执行），这也就是回调函数和异步经常结合的例子。

但是这个f方法只能调用一个回调函数

在这里就算是settimeout时间设置为0，也是将它作为异步放置到事件触发线程中等待主线程完毕

#### 二、事件监听

在f1程序执行完成时候触发done事件，在触发done事件后执行f2

<figure>
        <img src="https://lo56ve.github.io/img/async2.png">
</figure>

这种方法比第一种可以指定多个回调函数，而且可以去耦合，有利于实现模块化。但是缺点是程序变成了程序驱动型，运行流程变得很不清晰。

#### 三、观察者模式（发布订阅模式）

其实也就是将第二种的事件绑定改为发布publish，事件触发改为订阅subscribe，将事件理解成信号

#### 四、promise

promise，then可以接受3个函数作为参数，前两个参数对应promise的两种状态fulfilled和rejected的回调函数，第三个函数用于处理进度信息（可选，少用）

<figure>
        <img src="https://lo56ve.github.io/img/async3-4.png">
</figure>

### 后记

异步是nodejs里面很重要的一个核心，还有promise对象也比较重要，这一块等nodejs学习差不多再写一篇博文总结一下，感觉promise对象能把原来嵌套很多的回调函数，实现成then连接的链式结构，更易于维护